name: ðŸ“¨ PR Notifications + QA Summary

on:
  pull_request:
    branches: [ main ]
    types: [opened, reopened, synchronize, closed]

jobs:
  pr_notify:
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ðŸ§ª Run quick QA summary
      id: qa
      shell: bash
      run: |
        STATUS="unknown"

        if [ -f "scripts/check-backend.sh" ]; then
          chmod +x scripts/check-backend.sh
          bash scripts/check-backend.sh > qa.log 2>&1 || true

          if grep -q "FAIL" qa.log; then
            STATUS="failed"
          else
            STATUS="passed"
          fi
        else
          STATUS="missing"
        fi

        echo "status=$STATUS" >> $GITHUB_OUTPUT

    - name: ðŸ” Prepare PR metadata
      id: meta
      run: |
        echo "title=${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT
        echo "author=${{ github.event.pull_request.user.login }}" >> $GITHUB_OUTPUT
        echo "url=${{ github.event.pull_request.html_url }}" >> $GITHUB_OUTPUT

    - name: ðŸ”” Send Discord notification
      run: |
        QA="${{ steps.qa.outputs.status }}"
        PR_TITLE="${{ steps.meta.outputs.title }}"
        PR_AUTHOR="${{ steps.meta.outputs.author }}"
        PR_URL="${{ steps.meta.outputs.url }}"

        COLOR=7506394
        MSG="PR Update"

        if [ "$QA" = "passed" ]; then
          COLOR=3066993
          QA_TEXT="ðŸŸ¢ QA Passed"
        elif [ "$QA" = "failed" ]; then
          COLOR=15158332
          QA_TEXT="ðŸ”´ QA Failed"
        else
          COLOR=9807270
          QA_TEXT="âšª QA Script Missing"
        fi

        JSON=$(jq -n \
          --arg title "ðŸ“¨ PR Update" \
          --arg desc "**$PR_TITLE**\nBy **$PR_AUTHOR**\n[View PR]($PR_URL)\n\n$QA_TEXT" \
          --argjson color $COLOR \
          '{embeds:[{title:$title, description:$desc, color:$color}]}' )

        curl -s -H "Content-Type: application/json" \
          -d "$JSON" \
          "${{ secrets.DISCORD_WEBHOOK_URL }}"
