name: üõ°Ô∏è Privacy Scan (Maya)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  privacy-scan:
    name: üîé Scan RGPD / Donn√©es personnelles
    runs-on: ubuntu-latest

    steps:
    - name: üì• Checkout repo
      uses: actions/checkout@v4

    - name: üß™ Scan files and logs
      id: scan
      shell: bash
      run: |
        echo "üîç Analyse des fichiers, logs, exports, scripts..."

        # --- Patterns d√©tectables ---
        EMAIL_REGEX="[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}"
        PHONE_REGEX="\b[0-9]{3}[-. ]?[0-9]{3}[-. ]?[0-9]{4}\b"
        TOKEN_REGEX="(sk-|sbp_|service_|anon_)[A-Za-z0-9]{8,}"

        # --- Fichiers suspects ---
        TARGETS="./logs ./exports ./scripts ./supabase ./src"

        FOUND=false
        REPORT=""

        # Recherche des emails
        EMAILS=$(grep -R -E "$EMAIL_REGEX" $TARGETS || true)
        if [[ ! -z "$EMAILS" ]]; then
          FOUND=true
          REPORT+="üìß Emails d√©tect√©s:\n$EMAILS\n\n"
        fi

        # Recherche des num√©ros de t√©l√©phone
        PHONES=$(grep -R -E "$PHONE_REGEX" $TARGETS || true)
        if [[ ! -z "$PHONES" ]]; then
          FOUND=true
          REPORT+="üì± Num√©ros possibles:\n$PHONES\n\n"
        fi

        # Tokens API potentiels
        TOKENS=$(grep -R -E "$TOKEN_REGEX" $TARGETS || true)
        if [[ ! -z "$TOKENS" ]]; then
          FOUND=true
          REPORT+="üîë Tokens d√©tect√©s:\n$TOKENS\n\n"
        fi

        if [[ "$FOUND" = true ]]; then
          echo "status=fail" >> $GITHUB_OUTPUT
          echo "report<<EOF" >> $GITHUB_OUTPUT
          echo -e "$REPORT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          exit 1
        else
          echo "status=ok" >> $GITHUB_OUTPUT
        fi

    - name: üîî Notify Discord
      if: always()
      run: |
        STATUS="${{ steps.scan.outputs.status }}"

        if [[ "$STATUS" == "ok" ]]; then
          COLOR=3066993
          MESSAGE="üü¢ Privacy Scan OK ‚Äî aucun risque de donn√©es personnelles."
        else
          COLOR=15158332
          MESSAGE="üî¥ Privacy Scan FAILED ‚Äî donn√©es personnelles d√©tect√©es !"
        fi

        JSON=$(jq -n \
          --arg msg "$MESSAGE" \
          --arg rep "${{ steps.scan.outputs.report }}" \
          --argjson color $COLOR \
          '{embeds:[{title: "üõ°Ô∏è Privacy Scan (Maya)", description: ($msg + "\n\n```" + $rep + "```"), color:$color}]}' )

        curl -s -H "Content-Type: application/json" \
          -d "$JSON" \
          "${{ secrets.DISCORD_WEBHOOK_URL }}"
