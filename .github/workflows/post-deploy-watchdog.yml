name: Post-Deploy Watchdog & Rollback

on:
  workflow_run:
    workflows: ["Manual Deploy to Vercel"]
    types: [completed]
  workflow_dispatch:

jobs:
  verify-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üïµÔ∏è Fetch deployment URL
        run: |
          DEPLOY_URL="${{ github.event.workflow_run.outputs.url }}"
          echo "URL detected: $DEPLOY_URL"
          if [ -z "$DEPLOY_URL" ]; then
            echo "‚ö†Ô∏è No deployment URL found ‚Äî using fallback"
            DEPLOY_URL="https://sheet2scene.vercel.app"
          fi
          echo "DEPLOY_URL=$DEPLOY_URL" >> $GITHUB_ENV

      - name: üîç Ping site health endpoints
        run: |
          FAIL=false
          echo "---------------------------------------------------"
          echo "üß© Checking Sheet2Scene deployment health"
          echo "---------------------------------------------------"

          for path in "/" "/create" "/api/status" "/api/generate"; do
            echo "üîé Testing $DEPLOY_URL$path"
            resp=$(curl -s -o /dev/null -w "%{http_code}" "$DEPLOY_URL$path")
            if [ "$resp" -ge 200 ] && [ "$resp" -lt 400 ]; then
              echo "‚úÖ $path OK ($resp)"
            else
              echo "‚ùå $path failed ($resp)"
              FAIL=true
            fi
          done

          echo "FAIL=$FAIL" >> $GITHUB_ENV

      - name: üì¶ Archive Watchdog report
        run: |
          mkdir -p logs
          echo "{ \"timestamp\": \"$(date '+%Y-%m-%dT%H:%M:%S')\", \"deployment\": \"$DEPLOY_URL\", \"status\": \"$FAIL\" }" \
          > logs/watchdog-report.json

      - name: üì§ Upload report artifact
        uses: actions/upload-artifact@v4
        with:
          name: post-deploy-watchdog
          path: logs/watchdog-report.json

      - name: üîî Notify Discord
        run: |
          COLOR=65280
          TEXT="‚úÖ Deployment verified successfully ‚Äî all endpoints alive."
          if [ "$FAIL" = true ]; then
            COLOR=16711680
            TEXT="‚ùå Deployment issues detected ‚Äî rollback may be required."
          fi

          curl -s -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg title 'Sheet2Scene ‚Äî Post-Deploy Watchdog' \
              --arg desc \"$TEXT\nURL: $DEPLOY_URL\nTime: $(date '+%Y-%m-%d %H:%M:%S')\" \
              --argjson color $COLOR \
              '{embeds: [{title: $title, description: $desc, color: $color}]}')" \
            ${{ secrets.DISCORD_WEBHOOK }}

      - name: üßØ Automatic rollback (optional)
        if: ${{ env.FAIL == 'true' }}
        run: |
          echo "‚ö†Ô∏è Rolling back deployment..."
          npx vercel rollback --token=${{ secrets.VERCEL_TOKEN }}
