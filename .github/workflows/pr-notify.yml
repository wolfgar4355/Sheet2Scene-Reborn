name: ğŸ“¨ Sheet2Scene â€” Pull Request Notifications + QA Summary

on:
  pull_request:
    branches:
      - main
    types: [opened, reopened, synchronize, closed]

jobs:
  notify_discord:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§© Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ§  Run quick QA summary (if preview deploy exists)
        id: qa_check
        continue-on-error: true
        run: |
          if [ -f "scripts/check-backend.sh" ]; then
            chmod +x scripts/check-backend.sh
            bash scripts/check-backend.sh > qa_output.log 2>&1 || true
            if grep -q "FAIL" qa_output.log; then
              echo "qa_status=âŒ QA failed" >> $GITHUB_OUTPUT
            else
              echo "qa_status=âœ… QA passed" >> $GITHUB_OUTPUT
            fi
          else
            echo "qa_status=âš™ï¸ QA script not found" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“¨ Send Discord notification
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          PR_ACTION="${{ github.event.action }}"
          QA_STATUS="${{ steps.qa_check.outputs.qa_status }}"

          if [ "${{ github.event.pull_request.merged }}" = "true" ]; then
            STATUS="âœ… **Pull Request Merged into main!**"
          elif [ "$PR_ACTION" = "closed" ]; then
            STATUS="ğŸ›‘ **Pull Request Closed (not merged)**"
          elif [ "$PR_ACTION" = "synchronize" ]; then
            STATUS="ğŸ” **Pull Request Updated**"
          else
            STATUS="ğŸ†• **New Pull Request Opened**"
          fi

          MESSAGE="**$STATUS**\n\nğŸ“„ *$PR_TITLE*\nğŸ‘¤ Author: **$PR_AUTHOR**\nğŸ”— [View PR]($PR_URL)\n\nğŸ§ª QA Summary: $QA_STATUS"

          curl -H "Content-Type: application/json" \
               -d "{\"content\": \"$MESSAGE\"}" \
               ${{ secrets.DISCORD_WEBHOOK_URL }}
