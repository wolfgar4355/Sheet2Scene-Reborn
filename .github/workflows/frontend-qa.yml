name: Frontend QA & Build Validation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  frontend-qa:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Build Next.js
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_OPENAI_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: npm run build

      - name: Lint & Typecheck
        run: |
          npm run lint
          npm run typecheck

      - name: Verify Critical UI Components
        run: |
          for f in app/page.tsx app/layout.tsx components/ui/grimoire.tsx; do
            if [ -f "$f" ]; then
              echo "✔ Found: $f"
            else
              echo "✘ Missing: $f"
              exit 1
            fi
          done

      # Percy removed

      - name: Save QA Report
        if: always()
        run: |
          mkdir -p logs
          echo "{\"time\":\"$(date -u +"%Y-%m-%dT%H:%M:%S")\",\"frontend\":\"${{ job.status }}\"}" \
            > logs/frontend-report.json

      - name: Upload Report Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-qa-report
          path: logs/frontend-report.json

      - name: Notify Discord
        if: always()
        env:
          COLOR_SUCCESS: 65280
          COLOR_FAIL: 16711680
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            COLOR=$COLOR_SUCCESS
            DESC="Frontend QA Passed"
          else
            COLOR=$COLOR_FAIL
            DESC="Frontend QA Failed"
          fi

          JSON="$(jq -n \
            --arg title "Sheet2Scene QA" \
            --arg desc "$DESC" \
            --arg color "$COLOR" \
            '{username: "Sheet2Scene QA", embeds: [{title: $title, description: $desc, color: ($color|tonumber)}]}' \
          )"

          curl -H "Content-Type: application/json" \
            -d "$JSON" \
            "$WEBHOOK"
