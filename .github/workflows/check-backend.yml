name: üîç Check Backend & API

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  backend_check:
    name: Backend QA (Supabase + OpenAI)
    runs-on: ubuntu-latest

    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

    steps:
    - name: üì• Checkout repository
      uses: actions/checkout@v4

    - name: üü£ Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: üì¶ Install dependencies
      run: npm ci

    - name: ü§ñ Test OpenAI API
      id: test_openai
      run: |
        echo "Testing OpenAI connectivity..."
        curl -s https://api.openai.com/v1/models \
          -H "Authorization: Bearer $OPENAI_API_KEY" \
        | grep -q "gpt" \
        && echo "üü¢ OpenAI OK" \
        || (echo "‚ùå OpenAI failed" && exit 1)
      continue-on-error: true

    - name: üõ°Ô∏è Test Supabase API
      id: test_supabase
      run: |
        echo "Testing Supabase connectivity..."
        curl -s "$SUPABASE_URL/rest/v1/" \
          -H "apikey: $SUPABASE_SERVICE_KEY" \
        | grep -q "{}" \
        && echo "üü¢ Supabase OK" \
        || (echo "‚ùå Supabase failed" && exit 1)
      continue-on-error: true

    - name: üß™ Run backend checks
      id: run_backend
      run: |
        chmod +x scripts/check-backend.sh
        ./scripts/check-backend.sh
      continue-on-error: true

    - name: üóÇÔ∏è Process status summary
      id: summary
      run: |
        if [[ "${{ steps.test_openai.outcome }}" == "success" ]] \
        && [[ "${{ steps.test_supabase.outcome }}" == "success" ]] \
        && [[ "${{ steps.run_backend.outcome }}" == "success" ]]; then
          echo "status=success" >> $GITHUB_OUTPUT
        else
          echo "status=failure" >> $GITHUB_OUTPUT
        fi

    - name: üì¢ Notify Discord
      run: |
        if [[ "${{ steps.summary.outputs.status }}" == "success" ]]; then
          COLOR=65280
          DESC="üü¢ Backend QA Passed"
        else
          COLOR=16711680
          DESC="‚ùå Backend QA Failed"
        fi

        curl -s -H "Content-Type: application/json" \
        -d "$(jq -n --arg title "Sheet2Scene Backend QA" \
                  --arg desc "$DESC" \
                  --arg color "$COLOR" \
                  '{embeds:[{title:$title,description:$desc,color:($color|tonumber)}]}')" \
        $DISCORD_WEBHOOK_URL

    - name: üìù Commit & push report
      if: ${{ steps.summary.outputs.status == 'success' }}
      run: |
        git config --global user.name "s2s-bot"
        git config --global user.email "s2s-bot@users.noreply.github.com"
        git add logs/backend-report.json || echo "No changes"
        git commit -m "chore: update backend QA report [skip ci]" || echo "Nothing to commit"
        git push origin main
