name: üé® Design QA ‚Äî V√©rification visuelle & formats

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  design-qa:
    name: üîç V√©rification Design QA
    runs-on: ubuntu-latest

    steps:
      - name: üß∞ Cloner le d√©p√¥t
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Donner les permissions d‚Äôex√©cution aux scripts
        run: chmod +x ./scripts/check-assets-names.sh

      - name: üß™ V√©rifier formats & coh√©rence visuelle
        id: check_files
        run: |
          echo "üé® V√©rification des fichiers visuels et audio..."
          echo "------------------------------------------------------"
          echo ""

          ALLOWED_EXTENSIONS="webp|mp3|webm|ogg|woff2|svg|json|png|jpg|jpeg"
          BAD_FILES=$(find apps/web/public -type f ! -regex ".*\.\(${ALLOWED_EXTENSIONS}\)$")

          if [ -n "$BAD_FILES" ]; then
            echo "bad_files<<EOF" >> $GITHUB_ENV
            echo "$BAD_FILES" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
            echo "‚ùå Des fichiers non conformes ont √©t√© trouv√©s."
            exit 1
          else
            echo "‚úÖ Tous les fichiers ont des extensions autoris√©es."
          fi

          echo ""
          echo "üß© V√©rification du nommage (pr√©fixes bg-, ui-, fx-, font-, etc.)"
          ./scripts/check-assets-names.sh

      - name: üìä R√©sum√© du Design QA (rapport lisible)
        if: always()
        run: |
          echo ""
          echo "ü™û **R√©sum√© du Design QA**"
          echo ""
          echo "| V√©rification | R√©sultat |"
          echo "|--------------|-----------|"

          if [ "${{ steps.check_files.outcome }}" == "success" ]; then
            echo "| Formats & extensions | ‚úÖ Conformes |"
          else
            echo "| Formats & extensions | ‚ùå Non conformes |"
          fi

          if grep -q "‚úÖ Tous les fichiers respectent" ./scripts/check-assets-names.sh 2>/dev/null; then
            echo "| Nommage des assets | ‚úÖ Conforme |"
          else
            echo "| Nommage des assets | ‚ö†Ô∏è √Ä v√©rifier |"
          fi

          echo ""
          echo "üßæ Rapport complet consultable dans les logs GitHub Actions ci-dessus."

      - name: üïí Derniers fichiers modifi√©s (Bonus)
        if: always()
        run: |
          echo ""
          echo "üìÇ **Top 10 des fichiers modifi√©s r√©cemment**"
          echo ""
          echo "| Fichier | Extension | Date de modification |"
          echo "|----------|------------|----------------------|"
          find apps/web -type f -printf "| %P | %e | %TY-%Tm-%Td %TH:%TM |\n" | sort -r | head -10
          echo ""
          echo "üîé Ces fichiers ont √©t√© mis √† jour r√©cemment ‚Äî id√©al pour la revue visuelle."

      - name: ‚úÖ Succ√®s final
        if: ${{ success() }}
        run: echo "üéâ Tous les tests Design QA sont pass√©s avec succ√®s."

      - name: ‚ùå √âchec final
        if: ${{ failure() }}
        run: echo "üö® Certains fichiers n√©cessitent une correction. Consulte le rapport ci-dessus."

      - name: üì¢ Alerte Discord (succ√®s ou √©chec)
        if: always()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" = "success" ]; then
            COLOR=3066993
            EMOJI="‚úÖ"
            TITLE="Design QA r√©ussie"
            DESCRIPTION="Tous les fichiers visuels et audio sont conformes."
          else
            COLOR=15158332
            EMOJI="‚ùå"
            TITLE="Design QA √©chou√©e"
            DESCRIPTION="Certains fichiers ne respectent pas les conventions."
          fi

          MESSAGE="{
            \"embeds\": [{
              \"title\": \"$EMOJI $TITLE\",
              \"description\": \"$DESCRIPTION\",
              \"color\": $COLOR,
              \"fields\": [
                {\"name\": \"Auteur\", \"value\": \"${{ github.actor }}\", \"inline\": true},
                {\"name\": \"D√©p√¥t\", \"value\": \"${{ github.repository }}\", \"inline\": true},
                {\"name\": \"Commit\", \"value\": \"${{ github.event.head_commit.message }}\"}
              ],
              \"footer\": {\"text\": \"GodinVerse ‚Ä¢ Design QA Auto-Report\"},
              \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
            }]
          }"

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "$MESSAGE" \
               $DISCORD_WEBHOOK_URL
