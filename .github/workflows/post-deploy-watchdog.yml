name: üõ°Ô∏è Post-Deploy Watchdog & Health Check

on:
  workflow_run:
    workflows: ["Sheet2Scene ‚Äî Deploy to Vercel"]
    types: [completed]

jobs:
  watchdog:
    runs-on: ubuntu-latest

    steps:
    - name: üåê Set deployment URL
      run: |
        # URL de PROD (ajuste si n√©cessaire)
        echo "DEPLOY_URL=https://sheet2scene.vercel.app" >> $GITHUB_ENV

    - name: ü©∫ Checking endpoint health
      run: |
        FAIL=false
        echo "Testing Sheet2Scene endpoints..."

        for path in "/" "/create" "/api/status" "/api/generate"; do
          resp=$(curl -o /dev/null -s -w "%{http_code}" "$DEPLOY_URL$path")

          if [ "$resp" -ge 200 ] && [ "$resp" -lt 400 ]; then
            echo "üü¢ $path OK"
          else
            echo "üî¥ $path FAILED ($resp)"
            FAIL=true
          fi
        done

        echo "FAIL=$FAIL" >> $GITHUB_ENV

    - name: üìÅ Save watchdog report
      run: |
        mkdir -p logs
        echo "{\"timestamp\":\"$(date "+%Y-%m-%d %H:%M:%S")\",\"deploy\":\"$DEPLOY_URL\",\"fail\":\"$FAIL\"}" > logs/watchdog.json

    - name: üì§ Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: watchdog-report
        path: logs/watchdog.json

    - name: üîî Notify Discord
      run: |
        COLOR=3066993
        MSG="Deployment is healthy ‚úî"

        if [ "$FAIL" = "true" ]; then
          COLOR=15158332
          MSG="‚ö†Ô∏è Deployment issues detected"
        fi

        JSON=$(jq -n \
          --arg title "üõ°Ô∏è Sheet2Scene Post-Deploy Watchdog" \
          --arg desc "$MSG\nURL: $DEPLOY_URL\nTime: $(date "+%Y-%m-%d %H:%M:%S")" \
          --argjson color $COLOR \
          '{embeds: [{title: $title, description: $desc, color: $color}]}' )

        curl -s -H "Content-Type: application/json" \
          -d "$JSON" \
          "${{ secrets.DISCORD_WEBHOOK_URL }}"
