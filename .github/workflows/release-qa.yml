name: Release QA Summary & Pre-Deployment Check

on:
  workflow_run:
    workflows: ["Backend QA Full Suite", "Frontend QA & Build Validation"]
    types:
      - completed
  workflow_dispatch:

jobs:
  release-summary:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout repo
        uses: actions/checkout@v4

      - name: üìÇ Download QA Reports
        uses: actions/download-artifact@v4
        with:
          path: qa_reports
        continue-on-error: true

      - name: üß© Combine Backend & Frontend Reports
        run: |
          mkdir -p logs
          BACKEND=$(jq -r '.status // "missing"' qa_reports/backend-qa-report/backend-report.json 2>/dev/null || echo "missing")
          FRONTEND=$(jq -r '.frontend // "missing"' qa_reports/frontend-qa-report/frontend-report.json 2>/dev/null || echo "missing")

          echo "{ \"timestamp\": \"$(date '+%Y-%m-%dT%H:%M:%S')\", \"backend\": \"$BACKEND\", \"frontend\": \"$FRONTEND\" }" \
          | tee logs/release-summary.json

      - name: üì§ Upload Summary Artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-qa-summary
          path: logs/release-summary.json

      - name: üîî Notify Discord Summary
        run: |
          STATUS_BACK=$(jq -r '.backend' logs/release-summary.json)
          STATUS_FRONT=$(jq -r '.frontend' logs/release-summary.json)

          COLOR=65280
          TEXT="‚úÖ All QA checks passed"
          if [ "$STATUS_BACK" != "success" ] || [ "$STATUS_FRONT" != "success" ]; then
            COLOR=16711680
            TEXT="‚ùå Some QA checks failed"
          fi

          curl -s -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg title 'üì¶ Sheet2Scene ‚Äî Release QA Summary' \
              --arg desc \"$TEXT\nBackend: $STATUS_BACK\nFrontend: $STATUS_FRONT\n\nTriggered before Vercel deployment.\" \
              --argjson color $COLOR \
              '{embeds: [{title: $title, description: $desc, color: $color}]}')" \
            ${{ secrets.DISCORD_WEBHOOK }}

      - name: üöÄ Conditional Vercel Deployment
        if: ${{ success() }}
        run: |
          echo "All QA checks passed ‚Äî ready for Vercel deployment ‚úÖ"
          # optional: npx vercel --prod
