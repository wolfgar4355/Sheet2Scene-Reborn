name: üöÄ Sheet2Scene ‚Äî Preview Deploy & QA

on:
  push:
    branches-ignore:
      - main
  workflow_dispatch:

jobs:
  deploy_preview:
    runs-on: ubuntu-latest

    steps:
    - name: üì• Checkout Repository
      uses: actions/checkout@v4

    - name: üü¶ Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: üì¶ Install dependencies
      run: npm ci

    - name: üîß Run Backend QA before preview deploy
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        chmod +x scripts/check-backend.sh
        bash scripts/check-backend.sh

    - name: ‚ùå Notify Discord if QA fails
      if: failure()
      run: |
        JSON=$(jq -n \
          --arg desc "‚ùå Preview Deploy FAILED ‚Äî Sheet2Scene (branch: $GITHUB_REF_NAME) via GitHub Actions." \
          '{embeds:[{title:"Preview Deploy",description:$desc,color:15158332}]}' )
        curl -s -H "Content-Type: application/json" \
          -d "$JSON" \
          "${{ secrets.DISCORD_WEBHOOK_URL }}"

    - name: ‚ñ≤ Deploy to Vercel (Preview)
      if: success()
      env:
        VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
        VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      run: |
        npm install -g vercel
        PREVIEW_URL=$(vercel deploy --token $VERCEL_TOKEN --scope $VERCEL_ORG_ID --yes)
        echo "preview_url=$PREVIEW_URL" >> $GITHUB_OUTPUT

    - name: üì¢ Notify Discord (successful preview)
      if: success()
      run: |
        URL="${{ steps.deploy_preview.outputs.preview_url }}"
        JSON=$(jq -n \
          --arg url "$URL" \
          --arg desc "üü¢ Preview Deploy Successful ‚Äî Sheet2Scene (branch: $GITHUB_REF_NAME)\n‚û°Ô∏è Ready to test: $URL" \
          '{embeds:[{title:"Preview Deploy Success",description:$desc,color:3066993}]}' )
        curl -s -H "Content-Type: application/json" \
          -d "$JSON" \
          "${{ secrets.DISCORD_WEBHOOK_URL }}"
