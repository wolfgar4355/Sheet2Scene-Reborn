name: Release QA Summary & Pre-Deployment Check

on:
  workflow_run:
    workflows:
      - "Backend QA Full Suite"
      - "Frontend QA & Build Validation"
    types: [completed]
  workflow_dispatch:

jobs:
  release-summary:
    runs-on: ubuntu-latest

    steps:
    - name: üì¶ Checkout repo
      uses: actions/checkout@v4

    - name: üì• Download QA Reports
      uses: actions/download-artifact@v4
      with:
        pattern: "*qa-report*"
        path: qa_reports
      continue-on-error: true

    - name: üîÄ Combine Backend & Frontend Reports
      run: |
        mkdir -p logs

        BACKEND=$(jq -r '.status // "missing"' qa_reports/backend-qa-report/backend-report.json 2>/dev/null || echo "missing")
        FRONTEND=$(jq -r '.status // "missing"' qa_reports/frontend-qa-report/frontend-report.json 2>/dev/null || echo "missing")

        echo "{\"timestamp\": \"$(date +'%Y-%m-%dT%H:%M:%S')\", \"backend\": \"$BACKEND\", \"frontend\": \"$FRONTEND\"}" \
          > logs/release-summary.json

    - name: üì§ Upload Summary Artifact
      uses: actions/upload-artifact@v4
      with:
        name: release-qa-summary
        path: logs/release-summary.json

    - name: üîî Notify Discord Summary
      run: |
        BACKEND=$(jq -r '.backend' logs/release-summary.json)
        FRONTEND=$(jq -r '.frontend' logs/release-summary.json)

        if [ "$BACKEND" = "success" ] && [ "$FRONTEND" = "success" ]; then
          COLOR=65280
          TEXT="‚úÖ All QA checks passed"
        else
          COLOR=16711680
          TEXT="‚ùå Some QA checks failed"
        fi

        JSON=$(jq -n \
          --arg title "Sheet2Scene ‚Äì Release QA Summary" \
          --arg desc "Backend: $BACKEND\nFrontend: $FRONTEND" \
          --arg color "$COLOR" \
          '{embeds: [{title: $title, description: $desc, color: ($color|tonumber)}]}')

        curl -s -H "Content-Type: application/json" \
          -d "$JSON" \
          "${{ secrets.DISCORD_WEBHOOK_URL }}"

    - name: üü© Conditional Vercel Deployment
      if: success()
      run: |
        echo "All QA checks passed ‚Äì ready for Vercel deployment üöÄ"
