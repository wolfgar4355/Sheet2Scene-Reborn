name: Backend QA Full Suite

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  backend-qa:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Load Environment Variables
      run: |
        echo "OPENAI_API_KEY=${OPENAI_API_KEY}" >> .env
        echo "SUPABASE_URL=${SUPABASE_URL}" >> .env
        echo "SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}" >> .env
        echo "DISCORD_WEBHOOK=${DISCORD_WEBHOOK}" >> .env
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}

    - name: Run Backend QA Script
      run: |
        chmod +x scripts/check-backend.sh
        bash scripts/check-backend.sh

    - name: Generate QA Report
      if: always()
      run: |
        mkdir -p logs
        echo "{\"timestamp\": \"$(date '+%Y-%m-%dT%H:%M:%S')\", \"status\": \"${{ job.status }}\"}" \
          > logs/backend-report.json

    - name: Upload Report Artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: backend-qa-report
        path: logs/backend-report.json

    - name: Notify Discord
      if: always()
      env:
        WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      run: |
        if [ "${{ job.status }}" = "success" ]; then
          COLOR=65280
          DESC="Backend QA Passed"
        else
          COLOR=16711680
          DESC="Backend QA Failed"
        fi

        curl -H "Content-Type: application/json" \
          -d "{\"username\": \"Sheet2Scene Backend QA\", \"embeds\": [{\"title\": \"Backend QA\", \"description\": \"$DESC\", \"color\": $COLOR}]}" \
          "$WEBHOOK"
