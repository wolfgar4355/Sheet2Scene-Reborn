name: Frontend QA & Build Validation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  frontend-qa:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Build Next.js
        id: build_step
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_OPENAI_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set +e
          npm run build 2> build_err.log
          echo "status=$?" >> $GITHUB_OUTPUT
          echo "error_log<<EOF" >> $GITHUB_OUTPUT
          sed 's/"/\\"/g' build_err.log >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          exit 0

      - name: AAA v2 - Auto-Fix Patch Engine
        if: failure()
        run: |
          echo "ðŸ”§ Capture des logs..."
          sed 's/"/\\"/g' build_err.log > build_sanitized.log

          echo "ðŸ”® Envoi des logs Ã  ODIN..."
          PATCH_JSON=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -d "{\"repo\":\"sheet2scene\",\"project\":\"web\",\"logs\":\"$(cat build_sanitized.log)\"}" \
            https://sheet2scene-reborn.vercel.app/api/agents/run)

          echo "$PATCH_JSON" > patch.json

          if [ -s patch.json ]; then
            echo "ðŸ“¦ Patch reÃ§u, application AAA v2..."
            npm run apply:patch "$(cat patch.json)"
          else
            echo "âš ï¸ Aucun patch gÃ©nÃ©rÃ©. ODIN nâ€™a rien trouvÃ©."
          fi

      - name: Lint & Typecheck
        run: |
          npm run lint
          npm run typecheck

      - name: Verify Critical UI Components
        run: |
          for f in app/page.tsx app/layout.tsx components/ui/grimoire.tsx; do
            if [ -f "$f" ]; then
              echo "âœ“ Found: $f"
            else
              echo "âœ— Missing: $f"
              exit 1
            fi
          done

      - name: Save QA Report
        if: always()
        run: |
          mkdir -p logs
          echo "{\"time\":\"$(date -u +\"%Y-%m-%dT%H:%M:%S\")\",\"frontend\":\"${{ job.status }}\"}" \
            > logs/frontend-report.json

      - name: Upload Report Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-qa-report
          path: logs/frontend-report.json

      - name: Notify Discord
        if: always()
        env:
          COLOR_SUCCESS: 65280
          COLOR_FAIL: 16711680
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          if [[ "${{ job.status }}" == "success" ]]; then
            COLOR=$COLOR_SUCCESS
            DESC="Frontend QA Passed"
          else
            COLOR=$COLOR_FAIL
            DESC="Frontend QA Failed"
          fi

          JSON="$(jq -n \
            --arg title "Sheet2Scene QA" \
            --arg desc "$DESC" \
            --arg color "$COLOR" \
            '{username:"Sheet2Scene QA", embeds:[{title:$title, description:$desc, color: ($color|tonumber)}]}' )"

          curl -H "Content-Type: application/json" \
            -d "$JSON" \
            "$WEBHOOK"
