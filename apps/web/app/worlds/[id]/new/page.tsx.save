"use client";
import { useMemo, useState } from "react";
import type { Field } from "@/config/worlds";
import { WORLDS, BASE_FIELDS } from "@/config/worlds";

function FieldInput({ f, value, onChange }:{ f: Field; value?: string; onChange:(v:string)=>void }){
  if(f.kind==="text") return (<label style={{display:'block',marginBottom:12}}><div style={{fontWeight:600,marginBottom:4}}>{f.label}{(f as any).required?" *":""}</div><input value={value||""} onChange={e=>onChange(e.target.value)} placeholder={(f as any).placeholder} required={(f as any).required} style={{width:'100%',padding:8,border:'1px solid #ddd',borderRadius:8}}/></label>);
  if(f.kind==="textarea") return (<label style={{display:'block',marginBottom:12}}><div style={{fontWeight:600,marginBottom:4}}>{f.label}</div><textarea value={value||""} onChange={e=>onChange(e.target.value)} rows={(f as any).rows||4} style={{width:'100%',padding:8,border:'1px solid #ddd',borderRadius:8}}/></label>);
  return (<label style={{display:'block',marginBottom:12}}><div style={{fontWeight:600,marginBottom:4}}>{(f as any).label}{(f as any).required?" *":""}</div><select value={value||""} onChange={e=>onChange(e.target.value)} required={(f as any).required} style={{width:'100%',padding:8,border:'1px solid #ddd',borderRadius:8}}><option value="">‚Äî Choisir ‚Äî</option>{(f as any).options?.map((o:any)=>(<option key={o.id} value={o.id}>{o.label}</option>))}</select></label>);
}

export default function NewCharacter({ params }:{ params:{ id:string }}){
  const world = useMemo(()=>WORLDS.find(w=>w.id===params.id),[params.id]);
  const [data,setData]=useState<Record<string,string>>({});
  const [status,setStatus]=useState<"idle"|"saving"|"done"|"error">("idle");
  const [preview,setPreview]=useState<string>("");
  const [img,setImg]=useState<string|undefined>();
  if(!world) return <main><p>Monde introuvable.</p></main>;

  const fields: Field[] = [
    ...BASE_FIELDS,
    ...(world.sheet.races ? [{ kind:'select', id:'race', label:'Race', options: world.sheet.races }] as any : []),
    ...(world.sheet.classes ? [{ kind:'select', id:'class', label:'Classe', options: world.sheet.classes }] as any : []),
    ...(world.sheet.origins ? [{ kind:'select', id: world.sheet.origins.id, label: world.sheet.origins.label, options: world.sheet.origins.options }] as any : []),
  ];
  const onChange=(id:string,v:string)=>setData(d=>({...d,[id]:v}));
async function onSubmit(e: React.FormEvent) {
  e.preventDefault();
  setStatus("saving");

  try {
    const res = await fetch("/api/characters", {
      method: "POST",
      headers: { "content-type": "application/json" },
      body: JSON.stringify({
        worldId: world.id,
        ...data,
        imageUrl: img ?? undefined,
        prompt: preview ?? undefined,
      }),
    });

    const j = await res.json();
    setStatus(j.ok ? "done" : "error");
  } catch {
    setStatus("error");
  }
}
      const j=await res.json(); const style=world.tags?.slice(0,4).join(", "); const p=`Portrait ${world.name}: ${data.name||"Inconnu"} ‚Äî ${data.concept||""} ‚Äî ${style||""}`; setPreview(p);
      setStatus(j.ok?"done":"error");
    }catch{ setStatus("error"); }
  }
  async function onGenerate(){
    try{
      const res=await fetch("/api/generate",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({prompt:preview})});
      const j=await res.json(); if(j.ok && j.imageUrl) setImg(j.imageUrl); else alert(j.error||"Erreur g√©n√©ration");
    }catch(e:any){ alert(e?.message||"Erreur r√©seau"); }
  }

  return (<main><h1>Nouvel(te) perso ‚Äî {world.emoji} {world.name}</h1>
    <form onSubmit={onSubmit}>{fields.map((f:any)=>(<FieldInput key={f.id} f={f} value={data[f.id]} onChange={(v)=>onChange(f.id,v)} />))}
      <div style={{display:'flex',gap:12,marginTop:8}}>
        <button type="submit" disabled={status==='saving'}>Enregistrer</button>
        <button type="button" onClick={onGenerate}>G√©n√©rer l‚Äôimage</button>
      </div>
    </form>
    {preview && (<section style={{marginTop:18}}><h2>üñºÔ∏è Prompt d‚Äôimage</h2><pre style={{background:"#fafafa",padding:12,borderRadius:8,border:"1px solid #eee"}}>{preview}</pre></section>)}
    {img && <img src={img} alt="portrait" style={{maxWidth:'100%',borderRadius:12,border:'1px solid #ddd',marginTop:12}}/>}
  </main>);
}
