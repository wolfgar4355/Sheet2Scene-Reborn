name: üé® Design QA ‚Äì V√©rification visuelle & formats

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  check_design:
    name: V√©rification Design QA
    runs-on: ubuntu-latest

    steps:
    - name: üì• Cloner le d√©p√¥t
      uses: actions/checkout@v4

    - name: üîí Donner droits d‚Äôex√©cution aux scripts
      run: chmod +x ./scripts/check-assets-names.sh

    - name: üîç V√©rifier formats des fichiers visuels
      id: check_formats
      run: |
        echo "üîç V√©rification des formats (images + audio)..."

        ALLOWED_EXTENSIONS="png|jpg|jpeg|webp|svg|mp3|wav|ogg|mp4|json|gif"
        BAD_FILES=$(find public -type f ! -regex ".*\.\(${ALLOWED_EXTENSIONS}\)$")

        if [[ -n "$BAD_FILES" ]]; then
          echo "‚ùå Certains fichiers ont des extensions interdites"
          echo "$BAD_FILES"
          echo "bad=true" >> $GITHUB_OUTPUT
        else
          echo "‚úÖ Tous les fichiers ont des extensions autoris√©es"
          echo "bad=false" >> $GITHUB_OUTPUT
        fi

    - name: üî† V√©rifier les noms des assets (nomenclature)
      id: check_names
      run: |
        echo "üîç V√©rification de la nomenclature..."

        if ./scripts/check-assets-names.sh >/dev/null 2>&1; then
          echo "names_ok=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Tous les fichiers respectent la nomenclature"
        else
          echo "names_ok=false" >> $GITHUB_OUTPUT
          echo "‚ùå Certains fichiers NE respectent PAS la nomenclature"
        fi

    - name: üìù G√©n√©rer r√©sum√© QA
      id: summary
      run: |
        if [[ "${{ steps.check_formats.outputs.bad }}" == "false" && "${{ steps.check_names.outputs.names_ok }}" == "true" ]]; then
          echo "status=success" >> $GITHUB_OUTPUT
        else
          echo "status=failure" >> $GITHUB_OUTPUT
        fi

    - name: üì¢ Notification Discord
      run: |
        if [[ "${{ steps.summary.outputs.status }}" == "success" ]]; then
          COLOR=3066993
          DESC="üü¢ La v√©rification Design QA est pass√©e avec succ√®s."
        else
          COLOR=15158332
          DESC="‚ùå La v√©rification Design QA a √©chou√©."
        fi

        JSON=$(jq -n \
          --arg title "Sheet2Scene ‚Äì Design QA" \
          --arg desc "$DESC" \
          --argjson color $COLOR \
          '{embeds:[{title:$title,description:$desc,color:$color}]}' )

        curl -s -H "Content-Type: application/json" \
          -d "$JSON" \
          "${{ secrets.DISCORD_WEBHOOK_URL }}"
